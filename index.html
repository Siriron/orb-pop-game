<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Legendary Arc Orb Pop Challenge</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body, html {
  overflow:hidden;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #0a0a2a 0%, #0d0d3a 100%);
  color: #ffffff;
  height: 100vh;
}

#gameCanvas { 
  position:absolute; top:0; left:0; width:100%; height:100%; display:block; 
}

/* === TOP UI === */
#ui {
  position:absolute; top:20px; left:20px; z-index:100;
  display:flex; align-items:center; gap:30px;
}

#popCounter {
  font-size:32px; font-weight:bold;
  background: rgba(127, 90, 240, 0.15);
  border: 2px solid #7f5af0;
  padding:12px 20px;
  border-radius:8px;
  box-shadow: 0 0 20px rgba(127, 90, 240, 0.3);
}

#gameStatus {
  font-size:14px; color:#00f0ff;
  background: rgba(0, 240, 255, 0.1);
  border: 1px solid rgba(0, 240, 255, 0.3);
  padding:8px 12px;
  border-radius:6px;
}

/* === WALLET MODAL === */
#walletModal {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.7);
  display:flex; align-items:center; justify-content:center;
  z-index:1000;
  backdrop-filter:blur(4px);
}

#walletModalContent {
  background: linear-gradient(135deg, rgba(20, 20, 50, 0.95), rgba(30, 30, 60, 0.95));
  border: 2px solid #7f5af0;
  border-radius:12px;
  padding:40px;
  text-align:center;
  min-width:350px;
  box-shadow: 0 0 40px rgba(127, 90, 240, 0.4);
}

#walletModalContent h2 {
  font-size:28px;
  margin-bottom:10px;
  background: linear-gradient(135deg, #7f5af0, #00f0ff);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

#walletModalContent p {
  font-size:14px;
  color:#aaa;
  margin-bottom:30px;
  line-height:1.6;
}

#connectBtn, #leaderboardBtn {
  background: linear-gradient(135deg, #7f5af0, #9962ff);
  border:none;
  color:white;
  padding:14px 28px;
  font-size:16px;
  font-weight:bold;
  border-radius:8px;
  cursor:pointer;
  transition:all 0.3s ease;
  margin:10px;
  box-shadow: 0 4px 15px rgba(127, 90, 240, 0.4);
}

#connectBtn:hover { transform:translateY(-2px); box-shadow: 0 6px 25px rgba(127, 90, 240, 0.6); }
#connectBtn:disabled { opacity:0.5; cursor:not-allowed; }

#connectBtn.loading::after {
  content: '';
  display:inline-block;
  width:14px; height:14px;
  margin-left:8px;
  border:2px solid rgba(255,255,255,0.3);
  border-top-color:white;
  border-radius:50%;
  animation:spin 0.6s linear infinite;
}

@keyframes spin { to { transform:rotate(360deg); } }

/* === WALLET STATUS === */
#walletStatus {
  position:absolute; top:20px; right:20px; z-index:100;
  display:flex; align-items:center; gap:12px;
  background: rgba(0, 240, 255, 0.1);
  border: 2px solid #00f0ff;
  padding:10px 16px;
  border-radius:8px;
  font-size:14px;
  font-weight:bold;
  box-shadow: 0 0 20px rgba(0, 240, 255, 0.2);
}

#walletStatus .status-dot {
  width:8px; height:8px; background:#00ff00; border-radius:50%;
  box-shadow: 0 0 8px #00ff00;
}

#disconnectBtn {
  background:rgba(255,100,100,0.2);
  border:1px solid #ff6464;
  color:#ff9696;
  padding:4px 8px;
  border-radius:4px;
  font-size:12px;
  cursor:pointer;
  transition:all 0.2s;
}

#disconnectBtn:hover { background:rgba(255,100,100,0.4); }

/* === LEADERBOARD === */
#leaderboardPanel {
  position:absolute; bottom:20px; right:20px; z-index:100;
  width:320px;
  background: linear-gradient(135deg, rgba(20, 20, 50, 0.85), rgba(30, 30, 60, 0.85));
  border: 2px solid #00f0ff;
  border-radius:10px;
  padding:16px;
  max-height:400px;
  display:none;
  flex-direction:column;
  box-shadow: 0 0 30px rgba(0, 240, 255, 0.2);
  backdrop-filter:blur(10px);
}

#leaderboardPanel.active { display:flex; }

#leaderboardHeader {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
  padding-bottom:12px;
  border-bottom:1px solid rgba(0, 240, 255, 0.3);
}

#leaderboardHeader h3 {
  font-size:16px;
  color:#00f0ff;
  margin:0;
}

#leaderboardClose {
  background:none; border:none; color:#00f0ff;
  font-size:20px; cursor:pointer;
  transition:color 0.2s;
}

#leaderboardClose:hover { color:#7f5af0; }

#leaderboardList {
  overflow-y:auto;
  flex:1;
  display:flex;
  flex-direction:column;
  gap:8px;
  font-size:13px;
}

.leaderboard-entry {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  background:rgba(127, 90, 240, 0.1);
  border:1px solid rgba(127, 90, 240, 0.2);
  border-radius:6px;
  transition:all 0.2s;
}

.leaderboard-entry:hover {
  background:rgba(127, 90, 240, 0.2);
  border-color:rgba(127, 90, 240, 0.4);
}

.leaderboard-rank {
  font-weight:bold;
  color:#7f5af0;
  min-width:20px;
}

.leaderboard-rank.gold { color:#ffd700; }
.leaderboard-rank.silver { color:#c0c0c0; }
.leaderboard-rank.bronze { color:#cd7f32; }

.leaderboard-wallet {
  font-family:monospace;
  font-size:11px;
  color:#aaa;
  flex:1;
  margin:0 8px;
}

.leaderboard-score {
  font-weight:bold;
  color:#00f0ff;
}

#leaderboardLoading {
  text-align:center;
  color:#aaa;
  font-size:12px;
  padding:20px 0;
}

/* === TOAST NOTIFICATIONS === */
#toastContainer {
  position:fixed;
  bottom:30px; left:30px;
  z-index:500;
  display:flex;
  flex-direction:column;
  gap:10px;
  pointer-events:none;
}

.toast {
  background: linear-gradient(135deg, rgba(20, 20, 50, 0.9), rgba(30, 30, 60, 0.9));
  border:2px solid;
  border-radius:8px;
  padding:14px 18px;
  font-size:13px;
  font-weight:500;
  max-width:280px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  animation:slideIn 0.3s ease-out;
  pointer-events:all;
}

.toast.success { border-color:#00ff00; color:#00ff00; }
.toast.error { border-color:#ff6464; color:#ff9696; }
.toast.info { border-color:#00f0ff; color:#00f0ff; }
.toast.warning { border-color:#ffb800; color:#ffd700; }

@keyframes slideIn {
  from { transform:translateX(-400px); opacity:0; }
  to { transform:translateX(0); opacity:1; }
}

@keyframes slideOut {
  from { transform:translateX(0); opacity:1; }
  to { transform:translateX(-400px); opacity:0; }
}

.toast.removing { animation:slideOut 0.3s ease-out; }

/* === RECENT POPS === */
#recentPops {
  position:absolute; top:120px; left:20px;
  width:280px;
  background: rgba(17, 17, 42, 0.85);
  border: 2px solid rgba(127, 90, 240, 0.3);
  border-radius:10px;
  padding:12px;
  font-size:12px;
  max-height:140px;
  overflow-y:auto;
  display:none;
  z-index:100;
}

#recentPops.active { display:block; }

#recentPops h4 {
  color:#7f5af0;
  font-size:13px;
  margin-bottom:8px;
}

.recent-pop-item {
  padding:6px;
  background:rgba(127, 90, 240, 0.05);
  border-left:2px solid #7f5af0;
  margin-bottom:6px;
  color:#ccc;
  font-size:11px;
}

/* === RECORD BUTTON === */
#recordBtn {
  position:absolute; bottom:20px; left:20px;
  padding:12px 20px;
  background: linear-gradient(135deg, #7f5af0, #9962ff);
  border:none;
  border-radius:8px;
  color:white;
  font-weight:bold;
  font-size:14px;
  cursor:pointer;
  transition:all 0.3s;
  box-shadow: 0 4px 15px rgba(127, 90, 240, 0.4);
  z-index:100;
}

#recordBtn:hover:not(:disabled) { 
  transform:translateY(-2px); 
  box-shadow: 0 6px 25px rgba(127, 90, 240, 0.6);
}

#recordBtn:disabled {
  opacity:0.5;
  cursor:not-allowed;
}

/* === SCROLLBAR STYLING === */
::-webkit-scrollbar {
  width:6px;
}

::-webkit-scrollbar-track {
  background:rgba(127, 90, 240, 0.1);
  border-radius:10px;
}

::-webkit-scrollbar-thumb {
  background:rgba(127, 90, 240, 0.4);
  border-radius:10px;
}

::-webkit-scrollbar-thumb:hover {
  background:rgba(127, 90, 240, 0.6);
}
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<!-- WALLET MODAL -->
<div id="walletModal">
  <div id="walletModalContent">
    <h2>üéÆ Arc Orb Challenge</h2>
    <p>Connect your wallet to play and record your scores on-chain on Arc Testnet</p>
    <button id="connectBtn">Connect Wallet</button>
    <button id="leaderboardBtn" style="margin-top:5px;">View Leaderboard</button>
  </div>
</div>

<!-- TOP UI -->
<div id="ui">
  <div id="popCounter">Pops: 0</div>
  <div id="gameStatus">Arc Testnet ‚Ä¢ Ready</div>
</div>

<!-- WALLET STATUS -->
<div id="walletStatus" style="display:none;">
  <span class="status-dot"></span>
  <span id="walletAddressDisplay">0x0000‚Ä¶0000</span>
  <button id="disconnectBtn">Disconnect</button>
</div>

<!-- RECENT POPS PANEL -->
<div id="recentPops">
  <h4>Recent Pops</h4>
  <div id="recentPopsList"></div>
</div>

<!-- LEADERBOARD PANEL -->
<div id="leaderboardPanel">
  <div id="leaderboardHeader">
    <h3>Top Scorers</h3>
    <button id="leaderboardClose">‚úï</button>
  </div>
  <div id="leaderboardList">
    <div id="leaderboardLoading">Loading leaderboard...</div>
  </div>
</div>

<!-- BUTTONS -->
<button id="recordBtn">Record Score</button>

<!-- TOAST CONTAINER -->
<div id="toastContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// === TOAST NOTIFICATION SYSTEM ===
function showToast(message, type = 'info', duration = 3000) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  container.appendChild(toast);

  const removeTimer = setTimeout(() => {
    toast.classList.add('removing');
    setTimeout(() => toast.remove(), 300);
  }, duration);

  toast.addEventListener('click', () => {
    clearTimeout(removeTimer);
    toast.classList.add('removing');
    setTimeout(() => toast.remove(), 300);
  });
}

// === GAME STATE ===
const orbColors = [
  {color:'#7f5af0', type:'common'},
  {color:'#00f0ff', type:'rare'},
  {color:'#ff6fff', type:'epic'}
];

const orbCount = 8;
let orbs = [];
let pops = 0;
let recentPops = [];
let backgroundParticles = [];
let gameActive = false;
let isRecording = false;

// === AUDIO ===
const popSound = new Audio('https://freesound.org/data/previews/341/341695_3248244-lq.mp3');
popSound.volume = 0.3;
const streakSound = new Audio('https://freesound.org/data/previews/146/146726_2615112-lq.mp3');
streakSound.volume = 0.2;

// === WEB3 ===
let provider, signer, userAddress;
const contractAddress = "0x69f153233DB821382c5b7E03348304d161942539";
const contractABI = [
  "function popOrb(uint256 orbId) external",
  "function recordScore(uint256 totalPops) external",
  "event OrbPopped(address indexed user, uint256 orbId, uint256 timestamp)",
  "event ScoreRecorded(address indexed user, uint256 totalPops, uint256 timestamp)"
];
let contract;

// === ORB CLASS ===
class Orb {
  constructor(id, x, y, colorObj) {
    this.id = id;
    this.x = x;
    this.y = y;
    this.color = colorObj.color;
    this.type = colorObj.type;
    this.radius = 40 + Math.random() * 10;
    this.dx = (Math.random() * 2 - 1) * 1.5;
    this.dy = (Math.random() * 2 - 1) * 1.5;
    this.popped = false;
    this.trail = [];
  }

  draw() {
    if (this.popped) return;

    // Draw trail
    for (let i = 0; i < this.trail.length; i++) {
      const t = this.trail[i];
      ctx.beginPath();
      ctx.fillStyle = this.color;
      ctx.globalAlpha = 0.3 * (1 - i / this.trail.length);
      ctx.arc(t.x, t.y, this.radius * 0.6 * (1 - i / this.trail.length), 0, Math.PI * 2);
      ctx.fill();
    }

    ctx.globalAlpha = 1;

    // Draw orb
    ctx.beginPath();
    ctx.fillStyle = this.color;
    ctx.shadowColor = this.color;
    ctx.shadowBlur = 20;
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fill();
  }

  move() {
    if (this.popped) return;
    this.trail.unshift({x: this.x, y: this.y});
    if (this.trail.length > 10) this.trail.pop();
    this.x += this.dx;
    this.y += this.dy;

    if (this.x - this.radius < 0 || this.x + this.radius > canvas.width) this.dx *= -1;
    if (this.y - this.radius < 0 || this.y + this.radius > canvas.height) this.dy *= -1;
  }
}

// === BACKGROUND PARTICLES ===
class BgParticle {
  constructor() {
    this.x = Math.random() * canvas.width;
    this.y = Math.random() * canvas.height;
    this.radius = Math.random() * 2 + 1;
    this.dx = (Math.random() * 2 - 1) * 0.2;
    this.dy = (Math.random() * 2 - 1) * 0.2;
    this.alpha = Math.random() * 0.5 + 0.3;
  }

  draw() {
    ctx.beginPath();
    ctx.fillStyle = "#00ffff";
    ctx.globalAlpha = this.alpha;
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1;
  }

  move() {
    this.x += this.dx;
    this.y += this.dy;
    if (this.x < 0) this.x = canvas.width;
    if (this.x > canvas.width) this.x = 0;
    if (this.y < 0) this.y = canvas.height;
    if (this.y > canvas.height) this.y = 0;
  }
}

// === INITIALIZE ===
function spawnOrbs() {
  orbs = [];
  for (let i = 0; i < orbCount; i++) {
    const c = orbColors[Math.floor(Math.random() * orbColors.length)];
    orbs.push(new Orb(i, Math.random() * canvas.width, Math.random() * canvas.height, c));
  }
}

function spawnBackgroundParticles() {
  for (let i = 0; i < 100; i++) {
    backgroundParticles.push(new BgParticle());
  }
}

// === ANIMATION LOOP ===
function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  backgroundParticles.forEach(p => { p.move(); p.draw(); });
  orbs.forEach(o => { o.move(); o.draw(); });
  requestAnimationFrame(animate);
}

// === RECENT POPS ===
function addRecentPop(orb) {
  const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
  const walletShort = userAddress ? userAddress.slice(0, 6) + "‚Ä¶" + userAddress.slice(-4) : "0x0000‚Ä¶0000";
  recentPops.unshift(`[${time}] ${walletShort} ‚Ä¢ ${orb.type}`);
  if (recentPops.length > 5) recentPops.pop();

  const listEl = document.getElementById('recentPopsList');
  listEl.innerHTML = recentPops.map(p => `<div class="recent-pop-item">${p}</div>`).join('');

  if (pops % 5 === 0 && pops > 0) {
    try { streakSound.play(); } catch (e) {}
  }
}

// === SPAWN NEW ORB ===
function spawnNewOrb() {
  const c = orbColors[Math.floor(Math.random() * orbColors.length)];
  orbs.push(new Orb(orbs.length, Math.random() * canvas.width, Math.random() * canvas.height, c));
}

// === CANVAS CLICK ===
canvas.addEventListener('click', async (e) => {
  if (!gameActive) return;

  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  for (let orb of orbs) {
    if (orb.popped) continue;
    const dist = Math.hypot(mx - orb.x, my - orb.y);
    if (dist < orb.radius) {
      orb.popped = true;
      pops++;
      document.getElementById('popCounter').innerText = "Pops: " + pops;
      addRecentPop(orb);
      spawnNewOrb();

      try { popSound.play(); } catch (e) {}

      showToast(`Popped a ${orb.type} orb! üéØ`, 'success', 1500);
      await sendPopTransaction(orb.id);
      break;
    }
  }
});

// === WALLET CONNECTION ===
async function connectWallet() {
  if (!window.ethereum) {
    showToast('MetaMask not detected. Install it to play!', 'error');
    return;
  }

  try {
    const connectBtn = document.getElementById('connectBtn');
    connectBtn.disabled = true;
    connectBtn.classList.add('loading');
    showToast('Connecting wallet...', 'info');

    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    contract = new ethers.Contract(contractAddress, contractABI, signer);

    // Update UI
    document.getElementById('walletModal').style.display = 'none';
    document.getElementById('walletStatus').style.display = 'flex';
    document.getElementById('walletAddressDisplay').textContent = userAddress.slice(0, 6) + "‚Ä¶" + userAddress.slice(-4);
    document.getElementById('recentPops').classList.add('active');
    gameActive = true;

    connectBtn.disabled = false;
    connectBtn.classList.remove('loading');

    showToast('Wallet connected! Start popping! üéÆ', 'success');
  } catch (error) {
    console.error(error);
    showToast('Failed to connect wallet', 'error');
    const connectBtn = document.getElementById('connectBtn');
    connectBtn.disabled = false;
    connectBtn.classList.remove('loading');
  }
}

// === SEND POP TRANSACTION ===
async function sendPopTransaction(orbId) {
  if (!contract) return;
  try {
    const tx = await contract.popOrb(orbId);
    document.getElementById('gameStatus').textContent = 'Arc Testnet ‚Ä¢ Recording...';
    await tx.wait();
    document.getElementById('gameStatus').textContent = 'Arc Testnet ‚Ä¢ Ready';
  } catch (e) {
    console.error(e);
    // Silently fail - don't interrupt gameplay
  }
}

// === RECORD SCORE ===
document.getElementById('recordBtn').addEventListener('click', async () => {
  if (!gameActive) {
    showToast('Connect wallet first', 'warning');
    return;
  }

  if (pops === 0) {
    showToast('Pop some orbs first! üéØ', 'warning');
    return;
  }

  try {
    const recordBtn = document.getElementById('recordBtn');
    recordBtn.disabled = true;
    isRecording = true;

    showToast('Recording score on-chain...', 'info');

    const tx = await contract.recordScore(pops);
    document.getElementById('gameStatus').textContent = 'Arc Testnet ‚Ä¢ Recording...';

    await tx.wait();

    document.getElementById('gameStatus').textContent = 'Arc Testnet ‚Ä¢ Ready';
    recordBtn.disabled = false;
    isRecording = false;

    showToast(`Score recorded! üèÜ ${pops} pops saved to Arc`, 'success');
    await loadLeaderboard();
  } catch (error) {
    console.error(error);
    showToast('Failed to record score', 'error');
    const recordBtn = document.getElementById('recordBtn');
    recordBtn.disabled = false;
    isRecording = false;
  }
});

// === LEADERBOARD ===
async function loadLeaderboard() {
  if (!contract) return;

  const leaderboard = document.getElementById('leaderboardList');
  leaderboard.innerHTML = '<div id="leaderboardLoading">Loading leaderboard...</div>';

  try {
    // Fetch events from the contract
    const eventFilter = contract.filters.ScoreRecorded();
    const events = await contract.queryFilter(eventFilter);

    // Parse and aggregate scores by user
    const scoreMap = {};
    events.forEach(event => {
      const user = event.args.user;
      const score = event.args.totalPops.toNumber();
      if (!scoreMap[user] || scoreMap[user] < score) {
        scoreMap[user] = score;
      }
    });

    // Convert to array and sort
    const sorted = Object.entries(scoreMap)
      .map(([address, score]) => ({address, score}))
      .sort((a, b) => b.score - a.score)
      .slice(0, 10);

    if (sorted.length === 0) {
      leaderboard.innerHTML = '<div style="text-align:center;color:#aaa;padding:20px;">No scores recorded yet</div>';
      return;
    }

    // Render leaderboard
    leaderboard.innerHTML = sorted.map((entry, index) => {
      let rankClass = '';
      if (index === 0) rankClass = 'gold';
      else if (index === 1) rankClass = 'silver';
      else if (index === 2) rankClass = 'bronze';

      const isYou = entry.address.toLowerCase() === userAddress?.toLowerCase();
      return `
        <div class="leaderboard-entry" style="${isYou ? 'border-color:#00f0ff;background:rgba(0,240,255,0.15)' : ''}">
          <span class="leaderboard-rank ${rankClass}">#${index + 1}</span>
          <span class="leaderboard-wallet">${entry.address.slice(0, 6)}‚Ä¶${entry.address.slice(-4)}${isYou ? ' (you)' : ''}</span>
          <span class="leaderboard-score">${entry.score}</span>
        </div>
      `;
    }).join('');
  } catch (error) {
    console.error(error);
    leaderboard.innerHTML = '<div style="text-align:center;color:#ff9696;padding:20px;">Failed to load leaderboard</div>';
  }
}

// === LEADERBOARD UI ===
document.getElementById('leaderboardBtn').addEventListener('click', () => {
  if (!gameActive) {
    showToast('Connect wallet first', 'warning');
    return;
  }
  document.getElementById('leaderboardPanel').classList.add('active');
  loadLeaderboard();
});

document.getElementById('leaderboardClose').addEventListener('click', () => {
  document.getElementById('leaderboardPanel').classList.remove('active');
});

// === DISCONNECT ===
document.getElementById('disconnectBtn').addEventListener('click', () => {
  userAddress = null;
  provider = null;
  signer = null;
  contract = null;
  gameActive = false;
  pops = 0;
  recentPops = [];

  document.getElementById('walletModal').style.display = 'flex';
  document.getElementById('walletStatus').style.display = 'none';
  document.getElementById('recentPops').classList.remove('active');
  document.getElementById('leaderboardPanel').classList.remove('active');
  document.getElementById('popCounter').textContent = "Pops: 0";
  document.getElementById('connectBtn').disabled = false;
  document.getElementById('connectBtn').classList.remove('loading');

  showToast('Wallet disconnected', 'info');
});

// === START UP ===
document.getElementById('connectBtn').addEventListener('click', connectWallet);
spawnOrbs();
spawnBackgroundParticles();
animate();

// Handle window resize
window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});
</script>
</body>
</html>
